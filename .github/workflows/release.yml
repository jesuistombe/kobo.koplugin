name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  upload-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build plugin package
        run: |
          ./package.sh
          ls -lh /tmp/kobo.koplugin.zip /tmp/kobo-patches.zip

      - name: Generate checksums
        run: |
          cd /tmp
          sha256sum kobo.koplugin.zip > kobo.koplugin.zip.sha256
          sha256sum kobo-patches.zip > kobo-patches.zip.sha256
          cat kobo.koplugin.zip.sha256
          cat kobo-patches.zip.sha256

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            /tmp/kobo.koplugin.zip \
            /tmp/kobo.koplugin.zip.sha256 \
            /tmp/kobo-patches.zip \
            /tmp/kobo-patches.zip.sha256 \
            --repo ${{ github.repository }}
